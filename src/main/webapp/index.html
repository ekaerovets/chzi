<html>
<head>
    <meta charset="utf-8">
    <style>

        body {
            background: #e7e7e7;
        }

        button {
            background: linear-gradient(to top, #eeeeee, #aaaaaa);
            box-shadow: inset 0 0 0 1px #888888;
            border: none;
            border-radius: 5px;
            margin-top: 5px;
            margin-bottom: 5px;
        }

        button:hover {
            box-shadow: inset 0 0 0 1px #999999, 0 2px 4px #666666;
        }

        button:active {
            box-shadow: inset 0 0 0 1px #999999, inset 0 5px 30px #666666;
        }

        .text {
            font-size: 25px;
            height: 612px;
            background: #f4f4f4;
            overflow-y: scroll;
        }

        .char2 {
            color: orange;
        }

        .char3 {
            color: blue;
        }

        .char4 {
            color: #85009a;
        }

        .char5 {
            color: red;
        }

        .pinyin2, .pinyin3, .pinyin4, .pinyin5 {
            border-radius: 4px;
        }

        .pinyin2 {
            background: #d1ffcf;
        }

        .pinyin3 {
            background: #d0d0ff;
        }

        .pinyin4 {
            background: #ffff64;
        }

        .pinyin5 {
            background: #ffd1d1;
        }

        .fragment {
            border: 2px solid #FF0000;
            border-radius: 8px;
            background: #00FFF9;
        }

        .word2 {
            border: 2px dotted blue;
            border-radius: 6px;
            box-shadow: inset 0 0 5px 0 blue;
        }

        .word4 {
            border: 2px dotted #fd00ff;
            border-radius: 6px;
            box-shadow: inset 0 0 5px 0 #fd00ff;
        }

        /* lookup */
        .pinyin {

        }

        .meaning {

        }

        .m1 {

        }

        .m2 {
            margin-left: 10px;
        }

        .m4 {
            margin-left: 20px;
        }

        .ex {
            color: #626262;
        }

        .c {
            color: green;
        }

    </style>

</head>
<body>

<div id="container" style="width: 900px; height: 700px; margin: auto; border: 1px solid black">
    <div style="height: 700px; background: #cdcdff;">
        <div id="insert_new">
            <button id="read_update" onclick="serverSync()">Server sync</button>
            <button id="read_insert_new" onclick="readNewText()">InsertNew</button>
            <button id="toggle_fragment" onclick="ui.toggleFragment()">Toggle fragment</button>
        </div>
        <label for="text_insert"></label><textarea id="text_insert" style="width: 900px; height: 673px"></textarea>
        <button id="text_go" onclick="textGo()">Go</button>
        <button id="ordered" onclick="ordered()">Ordered</button>
        <div id="text_div" class="text" onmouseup="textDivMouseUp()" style="display: none"></div>
        <div id="char_info">
            <button id="char_trivia" onclick="ui.charTrivia()">T</button>
            <button id="char_learn" onclick="ui.charLearn()">L</button>
            <span id="char_glyph_info"></span>
            <span id="char_glyph_meaning"></span>
            <label for="char_input"></label><input id="char_input" onkeyup="ui.updateReadWordPanel()">
            <button id="char_edit" onclick="onEditCharClick()">Edit</button>
            <button id="char_save" onclick="ui.onSaveCharClick()">Save</button>
        </div>
        <div id="pinyin_info" style="margin-top: 5px">
            <button id="pinyin_trivia" onclick="ui.pinyinTrivia()">T</button>
            <button id="pinyin_learn" onclick="ui.pinyinLearn()">L</button>
            <span id="char_pinyin_value"></span>
            <label for="pinyin_input"></label><input id="pinyin_input" onkeyup="ui.updateReadWordPanel()">
            <button id="pinyin_edit" onclick="onEditPinyinClick()">Edit</button>
            <button id="pinyin_save" onclick="ui.onSavePinyinClick()">Save</button>
        </div>
        <div id="word_info" style="margin-top: 5px">
            <button id="word_trivia" onclick="ui.wordTrivia()">T</button>
            <button id="word_learn" onclick="ui.wordLearn()">L</button>
            <span id="char_word_value"></span>
            <label for="word_pinyin_input"></label><input id="word_pinyin_input" onkeyup="ui.updateReadWordPanel()">
            <label for="word_input"></label><input id="word_input" onkeyup="ui.updateReadWordPanel()">
            <button id="word_edit" onclick="onEditWordClick()">Edit</button>
            <button id="word_save" onclick="ui.onSaveWordClick()">Save</button>
        </div>

    </div>
    <div id="lookup" style="max-height: 200px; overflow-y: scroll; margin-top: 30px"></div>

</div>

<script>

    var DataHolder = function () {
        this.orderMap = {};
        let ziDict = JSON.parse(window.localStorage["zi_dict"]);
        for (var i = 0; i < ziDict.length; i++) {
            let key = ziDict[i].z;
            this.orderMap[key] = ziDict[i].o;
        }
    };

    DataHolder.prototype.loadFromServer = function () {

        // 1 - trivia, 2 - learning, 3 - new, 4 - queue
        function getType(diff, stage) {
            if (stage == 1) {
                return 1;
            } else if (stage == 2) {
                return diff < 0 ? 4 : 2;
            } else {
                return 3;
            }
        }

        /** Load pinyins and characters from server */
        try {
            var respData = this.restSend("rest/data", null, true);
        } catch (err) {
            alert("Cannot send request " + err);
            return;
        }

        let resp = JSON.parse(respData);
        let _chars = resp.chars;
        this.charStageMap = {};
        this.charMap = {};
        for (let i = 0; i < _chars.length; i++) {
            let cur = _chars[i];
            this.charStageMap[cur.word] = getType(cur.diff, cur.stage);
            this.charMap[cur.word] = cur;
        }
        var pins = resp.pinyins;
        this.pinyinStageMap = {};
        this.pinyinMap = {};
        for (let i = 0; i < pins.length; i++) {
            let cur = pins[i];
            this.pinyinStageMap[cur.word] = getType(cur.diff, cur.stage);
            this.pinyinMap[cur.word] = cur;
        }
        var words = resp.words;
        this.wordStageMap = {};
        this.wordMap = {};
        for (let i = 0; i < words.length; i++) {
            let cur = words[i];
            this.wordStageMap[cur.word] = getType(cur.diff, cur.stage);
            this.wordMap[cur.word] = cur;
        }

    };

    DataHolder.prototype.getIndex = function(word) {
        return this.orderMap[word];
    };

    DataHolder.prototype.getChar = function(word) {
        return this.charMap[word];
    };

    DataHolder.prototype.getPinyin = function(word) {
        return this.pinyinMap[word];
    };

    DataHolder.prototype.getWord = function(word) {
        return this.wordMap[word];
    };

    DataHolder.prototype.getCharStage = function(word) {
        return this.charStageMap[word];
    };

    DataHolder.prototype.getPinyinStage = function(word) {
        return this.pinyinStageMap[word];
    };

    DataHolder.prototype.getWordStage = function(word) {
        return this.wordStageMap[word];
    };

    DataHolder.prototype.setCharState = function(word, state) {
        if (!this.charStageMap[word]) {
            throw "Not found!"
        }
        if (state == 1) {
            this.charMap[word].stage = 1;
            this.charStageMap[word] = 1;
        } else if (state == 2) {
            this.charMap[word].stage = 2;
            this.charMap[word].diff = -1;
            this.charStageMap[word] = 4;
        }
        this.restSend("rest/set_stage", {word: word, stage: state, type: 'c'});
    };

    DataHolder.prototype.insertChar = function(char) {
        this.restSend("rest/upsert_char", char);
        this.charMap[char.word] = char;
        this.charStageMap[char.word] = 3;
    };

    DataHolder.prototype.setPinyinState = function(word, state) {
        if (!this.pinyinStageMap[word]) {
            throw "Not found!"
        }
        if (state == 1) {
            this.pinyinMap[word].stage = 1;
            this.pinyinStageMap[word] = 1;
        } else if (state == 2) {
            this.pinyinMap[word].stage = 2;
            this.pinyinMap[word].diff = -1;
            this.pinyinStageMap[word] = 4;
        }
        this.restSend("rest/set_stage", {word: word, stage: state, type: 'p'});
    };

    DataHolder.prototype.insertPinyin = function(pinyin) {
        this.restSend("rest/upsert_pinyin", pinyin);
        this.pinyinMap[pinyin.word] = pinyin;
        this.pinyinStageMap[pinyin.word] = 3;
    };

    DataHolder.prototype.setWordState = function(word, state) {
        if (!this.wordStageMap[word]) {
            throw "Not found!"
        }
        if (state == 1) {
            this.wordMap[word].stage = 1;
            this.wordStageMap[word] = 1;
        } else if (state == 2) {
            this.wordMap[word].stage = 2;
            this.wordMap[word].diff = -1;
            this.wordStageMap[word] = 4;
        }
        this.restSend("rest/set_stage", {word: word, stage: state, type: 'w'});
    };

    DataHolder.prototype.insertWord = function(word) {
        this.restSend("rest/upsert_word", word);
        this.wordMap[word.word] = word;
        this.wordStageMap[word.word] = 4;
    };

    DataHolder.prototype.hasWord = function(fragment) {
        for (let i = 2; i < 5; i++) {
            let r = this.wordStageMap[fragment.substring(0, i)];
            if (r && r != 1) {
                return {len: i, stage: r};
            }
        }
    };

    DataHolder.prototype.restSend = function(url, data, asGet) {
        var xhr = new XMLHttpRequest();
        xhr.open(asGet ? "GET" : "POST", url, false);
        xhr.send(JSON.stringify(data));
        if (xhr.status == 200) {
            return xhr.responseText;
        } else {
            throw "error";
        }
    };

    var holder = new DataHolder();
    holder.loadFromServer();


    var selection = {text: "", charEdit: false, pinyinEdit: false, wordEdit: false};

    /*
    UI ENGINE
    */

    var UI = function() {

    };

    UI.prototype.init = function() {
        let data = window.localStorage["fragments"];
        this.fragments = {};
        if (data) {
            let items = JSON.parse(data);
            for (let i = 0; i < items.length; i++) {
                let item = items[i];
                let key = item[0];
                if (this.fragments[key]) {
                    this.fragments[key].push(item);
                } else {
                    this.fragments[key] = [item];
                }
            }
        }
    };

    UI.prototype.show = function (id) {
        document.getElementById(id).style.display = "";
    };

    UI.prototype.hide = function (id) {
        document.getElementById(id).style.display = "none";
    };

/*    UI.prototype.enable = function (id) {
        document.getElementById(id).disabled = false;
    };

    UI.prototype.disable = function (id) {
        document.getElementById(id).disabled = true;
    };*/

    UI.prototype.getText = function (id) {
        return document.getElementById(id).value;
    };

    UI.prototype.getValue = function (id) {
        return document.getElementById(id).value;
    };

    UI.prototype.setText = function (id, text) {
        document.getElementById(id).textContent = text;
    };

    UI.prototype.setValue = function (id, text) {
        document.getElementById(id).value = text;
    };

    UI.prototype.setHtml = function (id, html) {
        document.getElementById(id).innerHTML = html;
    };

    UI.prototype.setMode = function(mode) {
        // 1 - insert
        // 2 - read
        if (mode == 1) {
            this.hide("insert_new");
            this.show("text_insert");
            this.show("text_go");
            this.show("ordered");
            this.hide("text_div");
            this.hide("char_info");
            this.hide("pinyin_info");
            this.hide("word_info");
        } else {
            this.show("insert_new");
            this.hide("text_insert");
            this.hide("text_go");
            this.hide("ordered");
            this.show("text_div");
            this.show("char_info");
            this.show("pinyin_info");
            this.show("word_info");
        }
    };

    UI.prototype.updateReadWordPanel = function() {
        let sel = selection.text;
        if (sel.length == 1 && holder.getIndex(sel) != null) {
            this.show("char_glyph_info");
            this.setText("char_glyph_info", sel + " (" + holder.getIndex(sel) + ")");
            let char = holder.getChar(sel);
            if (char == null) {
                this.hide("char_glyph_meaning");
                this.show("char_input");
                this.hide("char_edit");
                let inputText = this.getText("char_input");
                if (inputText.length > 0) {
                    this.show("char_save");
                } else {
                    this.hide("char_save");
                }
            } else {
                this.show("char_glyph_meaning");
                this.setText("char_glyph_meaning", char.meaning == "" ? "??" : char.meaning);
                this.hide("char_input");
                this.show("char_edit");
                this.hide("char_save");
            }
            // pinyins
            let pinyin = holder.getPinyin(sel);
            if (pinyin == null) {
                this.hide("char_pinyin_value");
                this.show("pinyin_input");
                this.hide("pinyin_edit");
                let inputText = this.getText("pinyin_input");
                if (inputText.length > 0) {
                    this.show("pinyin_save");
                } else {
                    this.hide("pinyin_save");
                }
            } else {
                this.show("char_pinyin_value");
                this.setText("char_pinyin_value", pinyin.pinyin);
                this.hide("pinyin_input");
                this.show("pinyin_edit");
                this.hide("pinyin_save");
            }
        } else {
            this.hide("char_glyph_info");
            this.hide("char_glyph_meaning");
            this.hide("char_input");
            this.hide("char_edit");
            this.hide("char_save");
            this.hide("char_pinyin_value");
            this.hide("pinyin_input");
            this.hide("pinyin_edit");
            this.hide("pinyin_save");
        }
        if (sel.length > 1 && sel.length < 5) {
            let word = holder.getWord(sel);
            if (word == null) {
                this.hide("char_word_value");
                this.show("word_input");
                this.show("word_pinyin_input");
                this.hide("word_edit");
                let inputText = this.getText("word_input");
                let pinyinText = this.getText("word_pinyin_input");
                if (inputText.length > 0 && pinyinText.length > 0) {
                    this.show("word_save");
                } else {
                    this.hide("word_save");
                }
            } else {
                this.show("char_word_value");
                this.setText("char_word_value", word.meaning);
                this.hide("word_input");
                this.hide("word_pinyin_input");
                this.show("word_edit");
                this.hide("word_save");
            }
        } else {
            this.hide("char_word_value");
            this.hide("word_input");
            this.hide("word_pinyin_input");
            this.hide("word_edit");
            this.hide("word_save");
        }
    };

    UI.prototype.textUpdate = function() {
        let text = "";
        let lines = this.currentText.split("\n");
        for (let i = 0; i < lines.length; i++) {
            text += this.processTextLine(lines[i].trim());
        }
        this.setHtml("text_div", text);
    };

    /* 的命运。  - bug */

    UI.prototype.processTextLine = function(line) {

        function getInnerClass(cur) {
            let curClass = "";
            if (holder.getIndex(cur)) {
                let stage = holder.getCharStage(cur);
                if (!stage) {
                    stage = 5;
                }
                if (stage > 1) {
                    curClass = 'char' + stage;
                }
                stage = holder.getPinyinStage(cur);
                if (!stage) {
                    stage = 5;
                }
                if (stage > 1) {
                    curClass += ' pinyin' + stage;
                }
            }
            return curClass;
        }

        let text = "<p style='text-indent: 20px'>";
        let fragLen = 0;
        let forceBreak = false;
        let innerClass = "";
        let outerClass = "";
        let prevInnerClass = "";
        let prevOuterClass = "";
        for (let i = 0; i < line.length; i++) {
            let cur = line[i];
            forceBreak = false;
            innerClass = getInnerClass(cur);
            if (fragLen > 1) {
                outerClass = prevOuterClass;
                if (outerClass == "fragment") {
                    innerClass = "";
                }
                fragLen--;
            } else if (fragLen <= 1) {
                if (fragLen == 1) {
                    fragLen--;
                }
                outerClass = "";
                let word = holder.hasWord(line.substring(i, i + 5));
                if (word) {
                    fragLen = word.len;
                    outerClass = 'word' + word.stage;
                    forceBreak = true;
                } else if (this.fragments[cur]) {
                    let frag = this.fragments[cur];
                    for (let j = 0; j < frag.length; j++) {
                        let item = frag[j];
                        if (item == line.substring(i, i + item.length)) {
                            fragLen = item.length;
                            outerClass = "fragment";
                            innerClass = "";
                            forceBreak = true;
                            break;
                        }
                    }
                }
            }
            if (prevOuterClass != outerClass || forceBreak) {
                if (prevInnerClass) {
                    text += "</span>";
                    prevInnerClass = "";
                }
                if (prevOuterClass) {
                    text += "</span>";
                    prevOuterClass = "";
                }
            }
            if (outerClass != prevOuterClass) {
                text += '<span class="' + outerClass + '">';
            }
            if (innerClass != prevInnerClass) {
                if (prevInnerClass) {
                    text += "</span>";
                }
                if (innerClass) {
                    text += '<span class="' + innerClass + '">';
                }
            }
            text += cur;
            prevOuterClass = outerClass;
            prevInnerClass = innerClass;
        }
        if (prevInnerClass) {
            text += "</span>";
        }
        if (prevOuterClass) {
            text += "</span>";
        }
        text += "</p>";
        return text;
    };

    UI.prototype.setNewText = function(text) {
        this.currentText = text;
        this.setMode(2);
        this.textUpdate();
    };

    UI.prototype.saveFragments = function() {
        let items = [];
        let keys = Object.keys(this.fragments);
        for (let i = 0; i < keys.length; i++) {
            let m = this.fragments[keys[i]];
            for (let j = 0; j < m.length; j++) {
                items.push(m[j]);
            }
        }
        window.localStorage.setItem("fragments", JSON.stringify(items));
    };

    UI.prototype.toggleFragment = function() {
        let sel = selection.text;
        if (sel.length < 2 || sel.length > 10) {
            return;
        }
        for (let i = 0; i < sel.length; i++) {
            if (!holder.getIndex(sel[i])) {
                return;
            }
        }
        let key = sel[0];
        if (this.fragments[key]) {
            let items = this.fragments[key];
            let found = false;
            for (let i = 0; i < items.length; i++) {
                if (items[i] == sel) {
                    items.splice(i, 1);
                    found = true;
                    break;
                }
            }
            if (!found) {
                items.push(sel);
            }
        } else {
            this.fragments[key] = [sel];
        }
        this.saveFragments();
        this.textUpdate();
    };

    UI.prototype.charTrivia = function() {
        let sel = selection.text;
        if (sel.length == 1 && holder.getCharStage(sel) != null) {
            holder.setCharState(sel, 1);
            this.textUpdate();
        }
    };

    UI.prototype.charLearn = function() {
        let sel = selection.text;
        if (sel.length == 1 && holder.getCharStage(sel) != null) {
            holder.setCharState(sel, 2);
            this.textUpdate();
        }
    };

    UI.prototype.pinyinTrivia = function() {
        let sel = selection.text;
        if (sel.length == 1 && holder.getPinyinStage(sel) != null) {
            holder.setPinyinState(sel, 1);
            this.textUpdate();
        }
    };

    UI.prototype.wordTrivia = function() {
        let sel = selection.text;
        if (sel.length > 1 && holder.getWordStage(sel) != null) {
            holder.setWordState(sel, 1);
            this.textUpdate();
        }
    };

    UI.prototype.onSaveCharClick = function () {
        var sel = selection.text;
        var char = this.getValue("char_input");
        var p = {word: sel, meaning: char};
        if (sel.length == 1 && holder.getIndex(sel) != null && char.length > 0) {
            try {
                holder.insertChar(p);
            } catch (err) {
                alert("Cannot update char");
                return;
            }
        } else {
            return;
        }
        selection.charEdit = false;
        this.updateReadWordPanel();
        this.textUpdate();
    };

    UI.prototype.pinyinLearn = function() {
        let sel = selection.text;
        if (sel.length == 1 && holder.getPinyinStage(sel) != null) {
            holder.setPinyinState(sel, 2);
            this.textUpdate();
        }
    };

    UI.prototype.wordLearn = function() {
        let sel = selection.text;
        if (sel.length > 1 && holder.getWordStage(sel) != null) {
            holder.setWordState(sel, 2);
            this.textUpdate();
        }
    };

    UI.prototype.onSavePinyinClick = function () {
        var char = selection.text;
        var pinyin = this.getValue("pinyin_input");
        var p = {word: char, pinyin: pinyin};
        if (char.length == 1 && holder.getIndex(char) != null && pinyin.length > 0) {
            try {
                holder.insertPinyin(p);
            } catch (err) {
                alert("Cannot update pinyin");
                return;
            }
        } else {
            return;
        }
        selection.pinyinEdit = false;
        this.updateReadWordPanel();
        this.textUpdate();
    };

    UI.prototype.onSaveWordClick = function () {
        var word = selection.text;
        var meaning = this.getValue("word_input");
        var pinyin = this.getValue("word_pinyin_input");
        var p = {word: word, meaning: meaning, pinyin: pinyin};
        if (word.length > 1 && pinyin.length > 0 && meaning.length > 0) {
            try {
                holder.insertWord(p);
            } catch (err) {
                alert("Cannot update word");
                return;
            }
        } else {
            return;
        }
        selection.wordEdit = false;
        this.updateReadWordPanel();
        this.textUpdate();
    };

    UI.prototype.lookupReplace = function(str) {
        str = str.replace(/\[m1]/g, "<div class='m1'>");
        str = str.replace(/\[m2]/g, "<div class='m2'>");
        str = str.replace(/\[m4]/g, "<div class='m4'>");
        str = str.replace(/\[\/m]/g, "</div>");
        str = str.replace(/\[i]/g, "<i>");
        str = str.replace(/\[\/i]/g, "</i>");
        str = str.replace(/\[c]/g, "<span class='c'>");
        str = str.replace(/\[\/c]/g, "</span>");
        str = str.replace(/\[b]/g, "<b>");
        str = str.replace(/\[\/b]/g, "</b>");
        str = str.replace(/\[\*]/g, "");
        str = str.replace(/\[\/\*]/g, "");
        str = str.replace(/\[ex]/g, "<span class='ex'>");
        str = str.replace(/\[\/ex]/g, "</span>");
        str = str.replace(/\\]/g, "]");
        str = str.replace(/\\\[/g, "[");
        return str;
    };

    UI.prototype.processResp = function(resp) {
        if (resp == "null") {
            return "";
        } else {
            var r = JSON.parse(resp);
            var pinyin = r.pinyin;
            var meaning = r.meaning;
            var res = "";
            res += "<div class='pinyin'>" + this.lookupReplace(pinyin) + "</div>";
            res += "<div class='meaning'>" + this.lookupReplace(meaning) + "</div>";
            return res;
        }
    };

    UI.prototype.lookup = function () {
        var text = selection.text;
        if (text.length > 0) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "rest/lookup/" + text, false);
            xhr.send();
            var resp;
            if (xhr.status == 200) {
                resp = xhr.responseText;
                this.setHtml("lookup", this.processResp(resp))
            } else {
                this.setHtml("lookup", "");
            }
        } else {
            this.setHtml("lookup", "");
        }
    };

    var ui = new UI();
    ui.init();
    ui.setMode(1);


    serverSync = function() {
        holder.loadFromServer();
        ui.textUpdate();
    };

    onEditCharClick = function () {

    };

    onSaveCharClick = function () {
        var char = selection.text;
        var meaning = getValue("char_input");
        var c = {word: char, meaning: meaning};
        if (char.length == 1 && ziOrder[char] != null && meaning.length > 0) {
            try {
                restSend("rest/update_char", {word: char, meaning: meaning});
            } catch (err) {
                alert("Cannot update char");
                return;
            }
        } else {
            return;
        }
        chars[char] = c;
        charsNew[char] = true;
        selection.charEdit = false;
        updateReadWordPanel();
        textUpdate();
    };

    onEditPinyinClick = function () {

    };


    function onEditMeaningClick() {
        var sel = read_word_selection;
        if (sel.length == 1) {
            var w = null;
            for (var i = 0; i < chars.length; i++) {
                if (chars[i].word == sel) {
                    w = chars[i];
                    break;
                }
            }
            if (w != null) {
                $("#read_text_input").val(w.meaning);
                read_word_editing = true;
            }
        }
        updateReadWordPanel();
    }


    function textDivMouseUp() {
        selection.text = window.getSelection().toString();
        ui.setValue("char_input", "");
        ui.setValue("pinyin_input", "");
        ui.setValue("word_input", "");
        ui.setValue("word_pinyin_input", "");
        ui.updateReadWordPanel();
        ui.lookup();
    }
    

    /* Text manipulation methods */

    // prints all characters ordered by frequency
    function ordered() {
        let text = "";
        var zi_dict = JSON.parse(window.localStorage["zi_dict"]);
        for (var i = 0; i < zi_dict.length; i++) {
            text += zi_dict[i].z;
        }
        ui.setNewText(text);
    }

    function textGo() {
        ui.setNewText(ui.getText("text_insert"));
    }

    function readNewText() {
        ui.setMode(1);
    }


    

</script>

</body>
</html>